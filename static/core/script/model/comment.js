"use strict";var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(function(){window.Comment=function(e){function t(e){_classCallCheck(this,t);var n=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return n.$el=e,n.__data__={},n.observe("pageNo",function(){return n.flip()}),n}return _inherits(t,Data),_createClass(t,[{key:"bind",value:function(){var e,t;return t=this,(e=this.$el).on("click","a.pager:not(.active)",function(){var e;return e=parseInt($(this).data().page),t.set({pageNo:e}),t.focus()}),e.on("click",".avatar, .emotion",function(){return $(this).animateBy("animated rubberBand")}),e.on("click","img:not(.emotion)",function(){return window.open($(this).attr("src").replace(/-.*/,"")+"-origin")}),e.on("click","span.btn-quote",function(){if(!app.lack("login"))return e.triggerHandler("event-quote",[$(this).closest(".item-comment")])}),e.on("dblclick",".content-comment",function(){var t;if(!app.lack("login")&&!(t=$(this).closest(".item-comment")).parent(".unfold").length)return e.triggerHandler("event-quote",[t])}),e.on("click",".unfold:not(.active)",function(){var e;return e=$(this),t.fetch(parseInt(e.data().cid)).fail(function(e){return $.info(e)}).done(function(n){return t.unfold(n,e)})}),e.on("click","a:not(.pager)",function(e){return e.preventDefault(),window.open($(this).attr("href"))})}},{key:"fetch",value:function(e){var t,n,r,o,i,a=this,c=this.get();return o=c.type,n=c.id,r=c.pageNo,t=$.Deferred(),this.isLocked?(t.reject(),t.promise()):(this.isLocked=!0,i=e?"/comment/quote/"+e:"/comment/"+n,app.get(i,{type:o,pageNo:r}).always(function(){return a.isLocked=!1}).fail(function(e){return t.reject(e)}).done(function(e){return t.resolve(e)}),t.promise())}},{key:"flip",value:function(){var e=this;return this.fetch().fail(function(e){return $.info(e)}).done(function(t){var n;return e.render(t),n={count:t.totalCount},e.$el.triggerHandler("event-flip",[n])})}},{key:"focus",value:function(e){var t,n,r;if(r=(t=app.dom.root).scrollTop(),n=this.$el.offset().top,!(!e&&r<=n&&n<=r+t.innerHeight()))return app.fn.scroll(n-10)}},{key:"render",value:function(e){var t,n;return n="<div class='area-pager'>"+(n=app.pager({page:e.pageNo,size:e.pageSize,count:e.totalCount}))+"</div>",t="<div class='inner'> "+(e.html.length?e.html:"<p class='alert'>尚无评论。</p>")+" </div>",this.$el.html(""+n+t+n).triggerHandler("event-render")}},{key:"unfold",value:function(e,t){return t.addClass("active").html(e.html)}}]),t}(),app.model.comment=function(e){var t,n;switch(n=(t=app.model.comment).map||(t.map={}),$.type(e)){case"string":return n[e];case"object":return n[e.attr("id")]=new Comment(e);default:return n}}}).call(void 0);